<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Androp ‚Äî Fast P2P File Share</title>

<!-- Google font -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<!-- QR lib -->
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

<!-- Initialize Firebase (v9 modular) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getDatabase } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCCAdWENmFuXfruVUywVHlQi4NJdbwRwSw",
    authDomain: "drop-48e1c.firebaseapp.com",
    databaseURL: "https://drop-48e1c-default-rtdb.firebaseio.com",
    projectId: "drop-48e1c",
    storageBucket: "drop-48e1c.firebasestorage.app",
    messagingSenderId: "1038653970015",
    appId: "1:1038653970015:web:4ecb0891a794c40758edea",
    measurementId: "G-MEF6129M9T"
  };

  const app = initializeApp(firebaseConfig);
  // expose DB globally for other script module to import window.db
  window.db = getDatabase(app);
</script>

<style>
  :root{
    --bg:#f6f7fb; --card:#ffffff; --muted:#6b7280;
    --accent:#2563eb; --accent-2:#06b6d4; --success:#10b981;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
  body{background:var(--bg);color:#0f172a;display:flex;align-items:flex-start;justify-content:center;padding:20px}
  .app{width:100%;max-width:980px}
  header{display:flex;align-items:center;gap:12px;padding:18px;border-radius:12px;background:linear-gradient(90deg,#fff,#fff);box-shadow:0 6px 22px rgba(15,23,42,0.06);margin-bottom:18px}
  .logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:20px}
  h1{font-size:20px;margin:0}
  p.lead{margin:0;color:var(--muted);font-size:13px}

  .grid{display:grid;grid-template-columns:320px 1fr;gap:18px}
  @media(max-width:880px){ .grid{grid-template-columns:1fr} }

  /* left column */
  .panel{background:var(--card);padding:16px;border-radius:12px;box-shadow:0 6px 18px rgba(15,23,42,0.04)}
  .section-title{font-weight:600;margin-bottom:8px}
  .profile-row{display:flex;align-items:center;gap:12px}
  .avatar{width:60px;height:60px;border-radius:10px;background:#f3f4f6;display:flex;align-items:center;justify-content:center;font-size:28px}
  input[type="text"]{width:100%;padding:10px;border-radius:10px;border:1px solid #e6e9ef}
  .emoji-list{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .emoji-btn{padding:8px;border-radius:10px;border:1px solid transparent;background:transparent;cursor:pointer;font-size:18px}
  .emoji-btn.sel{border-color:rgba(37,99,235,0.18);box-shadow:0 4px 12px rgba(37,99,235,0.06)}

  .btn{display:inline-block;padding:10px 12px;border-radius:10px;border:none;background:var(--accent);color:white;font-weight:600;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid rgba(15,23,42,0.06);color:var(--muted)}
  .muted{color:var(--muted);font-size:13px;margin-top:8px}

  /* right column dashboard */
  .dash{background:var(--card);padding:16px;border-radius:12px;box-shadow:0 6px 18px rgba(15,23,42,0.04)}
  .row{display:flex;gap:12px;align-items:center}
  .big-btn{flex:1;padding:14px;border-radius:12px;border:none;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;font-weight:700;font-size:15px;cursor:pointer}
  .small-btn{padding:10px;border-radius:10px;border:1px solid rgba(15,23,42,0.06);background:transparent;cursor:pointer}
  .center{display:flex;align-items:center;justify-content:center}

  .card-quiet{padding:12px;border-radius:10px;background:#fbfdff;border:1px solid rgba(15,23,42,0.03)}
  #qrCanvas{width:200px;height:200px;display:block;margin:auto}
  #roomIdDisplay{font-size:20px;font-weight:700;text-align:center;margin-top:8px}

  .file-row{display:flex;gap:12px;align-items:center}
  .progress{height:14px;background:#eef2ff;border-radius:999px;overflow:hidden;margin-top:8px}
  .progress > i{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent-2));transition:width 200ms linear}

  .recent-list{margin-top:12px;display:flex;flex-direction:column;gap:8px}
  .recent-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:#f8fafc;cursor:pointer}
  .recent-item:hover{background:#eef2ff}

  .status{margin-top:12px;font-weight:600}
  .notice{font-size:13px;color:var(--muted);margin-top:8px}

  /* subtle animations */
  .fade-in{animation:fadeIn .35s ease both}
  @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
</style>
</head>
<body>
  <div class="app">
    <header>
      <div class="logo">A</div>
      <div>
        <h1>Androp</h1>
        <p class="lead">Fast offline P2P file sharing ‚Äî simple, secure, beautiful.</p>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: Profile & controls -->
      <div class="panel fade-in">

        <div class="section-title">Profile</div>
        <div class="profile-row">
          <div class="avatar" id="avatarEmoji">üìÅ</div>
          <div style="flex:1">
            <input id="nameInput" type="text" placeholder="Your name (e.g. Ava)" />
            <div class="emoji-list" id="emojiList"></div>
            <div style="margin-top:8px">
              <button class="btn" id="saveProfileBtn">Save profile</button>
              <button class="btn ghost" id="editProfileBtn" style="display:none">Edit</button>
            </div>
          </div>
        </div>

        <hr style="margin:12px 0;border:0;border-top:1px solid rgba(15,23,42,0.04)">

        <div style="margin-top:8px">
          <div class="section-title">Quick Actions</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="big-btn" id="hostBtnLeft">Host</button>
            <button class="small-btn" id="joinBtnLeft">Join</button>
          </div>
          <div class="notice">Host creates a 4-digit room. Share via QR or room code. Rooms are deleted after session ends.</div>
        </div>

        <hr style="margin:12px 0;border:0;border-top:1px solid rgba(15,23,42,0.04)">

        <div>
          <div class="section-title">Recent</div>
          <div id="recentList" class="recent-list"></div>
        </div>

      </div>

      <!-- RIGHT: Dashboard -->
      <div class="dash fade-in">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:700;font-size:18px">Share files</div>
            <div class="muted">Choose host or join, then send files securely P2P.</div>
          </div>
          <div id="statusBadge" class="card-quiet">Not connected</div>
        </div>

        <div style="margin-top:14px" class="card-quiet">
          <div style="display:flex;gap:12px;flex-wrap:wrap">
            <button class="big-btn" id="hostBtn">Host (create room)</button>
            <div style="flex:1">
              <input id="joinInput" type="text" placeholder="Enter 4-digit room ID to join" style="padding:10px;border-radius:10px;border:1px solid #e6e9ef;width:100%"/>
              <div style="display:flex;gap:8px;margin-top:8px">
                <button class="btn" id="joinBtn">Join room</button>
                <button class="btn ghost" id="scanQrBtn">Scan QR</button>
              </div>
            </div>
          </div>

          <div id="qrArea" style="margin-top:14px;display:none">
            <canvas id="qrCanvas"></canvas>
            <div id="roomIdDisplay"></div>
            <div class="muted">Scan this QR or give the 4-digit code to your friend</div>
          </div>

        </div>

        <div style="margin-top:12px" class="card-quiet">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:700">File transfer</div>
            <div class="muted">Choose a file to send</div>
          </div>

          <div style="margin-top:10px" class="file-row">
            <input id="fileInput" type="file" />
            <button class="btn" id="sendBtn" disabled>Send</button>
          </div>

          <div class="progress"><i id="progressBar"></i></div>
          <div id="transferNotice" class="muted" style="margin-top:8px">No transfers yet</div>

          <div style="margin-top:12px">
            <div style="font-weight:700">Received files</div>
            <div id="receivedFiles" style="margin-top:8px"></div>
          </div>
        </div>

      </div>
    </div>
  </div>

<!-- Main functional script -->
<script type="module">
import { ref, set, get, onValue, push, remove } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

/* -------------------------
   Utility & UI references
   ------------------------- */
const nameInput = document.getElementById('nameInput');
const avatarEmoji = document.getElementById('avatarEmoji');
const emojiList = document.getElementById('emojiList');
const saveProfileBtn = document.getElementById('saveProfileBtn');
const editProfileBtn = document.getElementById('editProfileBtn');

const hostBtnLeft = document.getElementById('hostBtnLeft');
const joinBtnLeft = document.getElementById('joinBtnLeft');

const hostBtn = document.getElementById('hostBtn');
const joinBtn = document.getElementById('joinBtn');
const scanQrBtn = document.getElementById('scanQrBtn');
const joinInput = document.getElementById('joinInput');

const qrArea = document.getElementById('qrArea');
const qrCanvas = document.getElementById('qrCanvas');
const roomIdDisplay = document.getElementById('roomIdDisplay');

const statusBadge = document.getElementById('statusBadge');
const fileInput = document.getElementById('fileInput');
const sendBtn = document.getElementById('sendBtn');
const progressBar = document.getElementById('progressBar');
const transferNotice = document.getElementById('transferNotice');
const receivedFiles = document.getElementById('receivedFiles');

const recentList = document.getElementById('recentList');

const EMOJIS = ["üòÄ","üòé","üöÄ","üìÅ","ü§ù","üì§","üì•","üîó","‚ú®","üî•","üåä","üçÄ","üéØ","üõ∏","ü¶Ñ"];
let selectedEmoji = localStorage.getItem('andropEmoji') || EMOJIS[0];

/* -------------------------
   Local storage & recents
   ------------------------- */
function loadProfile(){
  const name = localStorage.getItem('andropName') || `User${Math.floor(Math.random()*9000)}`;
  nameInput.value = name;
  selectedEmoji = localStorage.getItem('andropEmoji') || selectedEmoji;
  avatarEmoji.textContent = selectedEmoji;
}
function saveProfile(){
  localStorage.setItem('andropName', nameInput.value || `User${Math.floor(Math.random()*9000)}`);
  localStorage.setItem('andropEmoji', selectedEmoji);
  avatarEmoji.textContent = selectedEmoji;
  saveRecentProfile(); // store profile snapshot
  refreshUIAfterProfile();
}
function saveRecentProfile(){
  // we keep the list of recent profiles/devices to show maybe later (simple)
  const p = {name: nameInput.value || '', emoji:selectedEmoji, ts: Date.now()};
  localStorage.setItem('androp_profile', JSON.stringify(p));
}

/* -------------------------
   Emoji buttons
   ------------------------- */
function renderEmojiButtons(){
  EMOJIS.forEach(e=>{
    const b = document.createElement('button');
    b.className = 'emoji-btn' + (e===selectedEmoji? ' sel' : '');
    b.innerText = e;
    b.onclick = ()=>{ selectedEmoji = e; document.querySelectorAll('.emoji-btn').forEach(x=>x.classList.remove('sel')); b.classList.add('sel'); avatarEmoji.textContent = e; };
    emojiList.appendChild(b);
  });
}
renderEmojiButtons();

/* -------------------------
   Recent rooms
   ------------------------- */
function loadRecentRooms(){
  recentList.innerHTML = '';
  const arr = JSON.parse(localStorage.getItem('androp_recents') || '[]');
  arr.slice(0,6).forEach(room=>{
    const div = document.createElement('div');
    div.className = 'recent-item';
    div.innerHTML = `<div>${room}</div><div><button class="small-btn" data-room="${room}">Join</button></div>`;
    recentList.appendChild(div);
    div.querySelector('button').onclick = ()=>{ joinInput.value = room; startJoin(room); };
  });
}
function pushRecent(room){
  let arr = JSON.parse(localStorage.getItem('androp_recents') || '[]');
  arr = arr.filter(r=>r!==room);
  arr.unshift(room);
  localStorage.setItem('androp_recents', JSON.stringify(arr.slice(0,6)));
  loadRecentRooms();
}

/* -------------------------
   Firebase DB reference
   ------------------------- */
const db = window.db; // set in earlier inline module
if(!db) alert('Firebase DB not available ‚Äî check initialization.');

/* -------------------------
   WebRTC variables
   ------------------------- */
let pc = null;
let dataChannel = null;
let roomId = null;
let isHost = false;
let recvBuffers = [];
let incomingMeta = null;

/* -------------------------
   Create and cleanup PC
   ------------------------- */
function createPeer(isOfferer){
  pc = new RTCPeerConnection();
  pc.onicecandidate = (e)=>{
    if(e.candidate){
      // push candidate under room/candidates/host or joiner
      const role = isHost ? 'host' : 'joiner';
      const candRef = ref(db, `rooms/${roomId}/candidates/${role}`);
      push(candRef, e.candidate.toJSON());
    }
  };
  pc.onconnectionstatechange = ()=> updateStatus(pc.connectionState);
  pc.ondatachannel = (ev)=>{
    dataChannel = ev.channel;
    setupDataChannel();
  };
  if(isOfferer){
    dataChannel = pc.createDataChannel('file');
    setupDataChannel();
  }
}

/* -------------------------
   DataChannel handlers
   ------------------------- */
function setupDataChannel(){
  dataChannel.binaryType = 'arraybuffer';
  dataChannel.onopen = ()=> {
    updateStatus('connected');
    sendBtn.disabled = false;
    transferNotice.textContent = 'Connected ‚Äî you can send files';
  };
  dataChannel.onclose = ()=> {
    updateStatus('disconnected');
    sendBtn.disabled = true;
    transferNotice.textContent = 'Channel closed';
    cleanupAndDeleteRoom();
  };
  dataChannel.onerror = (e)=> console.warn('DC error', e);
  dataChannel.onmessage = (ev)=> handleIncoming(ev.data);
}

/* -------------------------
   Signalling helpers (Firebase)
   ------------------------- */
import { ref as dbRef } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
import { set as dbSet } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
import { get as dbGet } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
import { onValue as dbOnValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
import { push as dbPush } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
import { remove as dbRemove } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

/* convenience wrappers */
const ref = (p)=> dbRef(db, p);
const setRef = (p, v)=> dbSet(ref(p), v);
const getRef = (p)=> dbGet(ref(p));
const listenRef = (p, cb)=> dbOnValue(ref(p), cb);
const pushRef = (p, v)=> dbPush(ref(p), v);
const removeRef = (p)=> dbRemove(ref(p));

/* -------------------------
   HOST flow: create room, write offer, wait for answer
   ------------------------- */
hostBtn.onclick = hostBtnLeft.onclick = async ()=>{
  saveProfile();
  isHost = true;
  roomId = String(Math.floor(1000 + Math.random()*9000)); // 4-digit
  pushRecentUIOnHostStart();
  qrArea.style.display = 'block';
  roomIdDisplay.textContent = `Room ID: ${roomId}`;
  QRCode.toCanvas(qrCanvas, roomId, {width:200});

  createPeer(true);
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  // save offer to firebase
  await setRef(`rooms/${roomId}/offer`, offer.toJSON());
  updateStatus('waiting');

  // listen for answer
  listenRef(`rooms/${roomId}/answer`, async snap=>{
    const val = snap.val();
    if(val && pc && !pc.currentRemoteDescription){
      await pc.setRemoteDescription(val);
      updateStatus('connected');
      pushRecent(roomId);
      startListeningCandidates(); // start listening for joiner candidates
    }
  });

  // listen for joiner candidates (host will get joiner candidates)
  listenRef(`rooms/${roomId}/candidates/joiner`, snap=>{
    if(!pc) return;
    snap.forEach(child=>{
      const c = child.val();
      try{ pc.addIceCandidate(c); }catch(e){}
    });
  });
};

/* -------------------------
   JOIN flow: read offer, create answer
   ------------------------- */
joinBtn.onclick = ()=> startJoin(joinInput.value.trim());
async function startJoin(id){
  if(!id || id.length!==4){ alert('Enter a 4-digit room ID'); return; }
  saveProfile();
  isHost = false;
  roomId = id;
  updateStatus('joining');
  createPeer(false);

  // read offer
  const offerSnap = await getRef(`rooms/${roomId}/offer`);
  const offer = offerSnap.val();
  if(!offer){ alert('Room not found or already closed'); updateStatus('idle'); return; }

  await pc.setRemoteDescription(offer);
  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  // write answer
  await setRef(`rooms/${roomId}/answer`, answer.toJSON());

  // listen host ICE candidates
  listenRef(`rooms/${roomId}/candidates/host`, snap=>{
    if(!pc) return;
    snap.forEach(child=>{
      const c = child.val();
      try{ pc.addIceCandidate(c); }catch(e){}
    });
  });

  // push local candidates will be handled by pc.onicecandidate (we already set)
  updateStatus('connected');
  QRCode.toCanvas(qrCanvas, roomId, {width:200}); // show the same id after join
  roomIdDisplay.textContent = `Room ID: ${roomId}`;
  pushRecent(roomId);
}

/* -------------------------
   Candidate listening for adding our own remote candidates (joiner->host handled in host flow).
   For both roles we should also listen to remote candidates depending on role which we set above.
   ------------------------- */
function startListeningCandidates(){
  // host already listens for joiner in host flow
  // joiner listens for host in startJoin
}

/* -------------------------
   File send / receive (DataChannel)
   ------------------------- */
sendBtn.onclick = async ()=>{
  if(!dataChannel || dataChannel.readyState !== 'open'){ alert('Not connected to peer'); return; }
  const file = fileInput.files[0];
  if(!file){ alert('Choose a file first'); return; }

  // send metadata first
  const meta = {type:'meta', name:file.name, size:file.size, mime:file.type};
  dataChannel.send(JSON.stringify(meta));

  const CHUNK = 64 * 1024;
  let offset = 0;
  transferNotice.textContent = 'Sending...';
  progressBar.style.width = '0%';

  while(offset < file.size){
    const slice = file.slice(offset, offset + CHUNK);
    const ab = await slice.arrayBuffer();

    // backpressure handling
    if(dataChannel.bufferedAmount > CHUNK * 16){
      await new Promise(r => { dataChannel.addEventListener('bufferedamountlow', function h(){ dataChannel.removeEventListener('bufferedamountlow', h); r(); }); });
    }
    dataChannel.send(ab);
    offset += ab.byteLength;
    const pct = Math.round((offset / file.size) * 100);
    progressBar.style.width = pct + '%';
  }

  // done marker
  dataChannel.send(JSON.stringify({type:'done'}));
  transferNotice.textContent = 'Send complete';
  progressBar.style.width = '100%';

  // after sending, we can optionally cleanup and delete room (we will delete when both sides close)
};

/* -------------------------
   Handle incoming DataChannel messages
   ------------------------- */
function handleIncoming(data){
  // if string -> meta or done
  if(typeof data === 'string'){
    try{
      const obj = JSON.parse(data);
      if(obj.type === 'meta'){
        incomingMeta = obj;
        recvBuffers = [];
        transferNotice.textContent = `Receiving ${obj.name} (${formatBytes(obj.size)})`;
        progressBar.style.width = '0%';
        return;
      } else if(obj.type === 'done'){
        // finalize
        if(incomingMeta){
          const blob = new Blob(recvBuffers, {type: incomingMeta.mime || 'application/octet-stream'});
          offerDownload(blob, incomingMeta.name);
          incomingMeta = null;
          recvBuffers = [];
          transferNotice.textContent = 'Receive complete';
          progressBar.style.width = '100%';
          // delete room now that transfer finished (clean up)
          cleanupAndDeleteRoom();
        }
        return;
      }
    }catch(e){}
  } else {
    // binary chunk
    recvBuffers.push(data);
    if(incomingMeta){
      const received = recvBuffers.reduce((s,b)=>s+b.byteLength,0);
      const pct = Math.round(received / incomingMeta.size * 100);
      progressBar.style.width = pct + '%';
      transferNotice.textContent = `Receiving ${incomingMeta.name} ‚Äî ${pct}%`;
    }
  }
}

/* create download link */
function offerDownload(blob, filename){
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename;
  a.textContent = `Download ${filename}`;
  a.className = 'muted';
  receivedFiles.prepend(a);
  receivedFiles.prepend(document.createElement('br'));
}

/* -------------------------
   Helpers: format bytes & status
   ------------------------- */
function formatBytes(bytes){
  if(bytes===0) return '0 B';
  const sizes = ['B','KB','MB','GB','TB'];
  const i = Math.floor(Math.log(bytes)/Math.log(1024));
  return (bytes/Math.pow(1024,i)).toFixed(i===0?0:2) + ' ' + sizes[i];
}

function updateStatus(state){
  if(!state) state='idle';
  const map = {new:'new',connecting:'connecting',connected:'Connected ‚úÖ',disconnected:'Not connected',failed:'Failed',closed:'Closed'};
  statusBadge.textContent = map[state] || state;
}

/* -------------------------
   Clean up & delete room from Firebase
   ------------------------- */
async function cleanupAndDeleteRoom(){
  try{
    if(roomId){
      // remove the room node
      await removeRef(`rooms/${roomId}`);
      // also remove answer and candidates if exist
      await removeRef(`rooms/${roomId}`);
    }
  }catch(e){ console.warn('cleanup error', e); }

  // close pc & dc
  try{ if(dataChannel) dataChannel.close(); }catch(e){}
  try{ if(pc) pc.close(); }catch(e){}
  dataChannel = null; pc = null;
  roomId = null;
  isHost = false;
  updateStatus('disconnected');
  // hide QR area
  qrArea.style.display = 'none';
  roomIdDisplay.textContent = '';
}

/* -------------------------
   Wire UI: scan QR (simple camera scanning)
   ------------------------- */
scanQrBtn.onclick = async ()=>{
  // open prompt to ask user to paste code or allow camera scanning via built-in prompt
  const choice = confirm('Scan with camera? Press Cancel to paste code instead.');
  if(!choice){
    const pasted = prompt('Paste the 4-digit room code:');
    if(pasted) startJoin(pasted.trim());
    return;
  }
  // camera scanning (simple)
  try{
    const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
    const video = document.createElement('video');
    video.srcObject = stream;
    video.play();
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');

    const scan = ()=> {
      if(video.readyState === video.HAVE_ENOUGH_DATA){
        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
        ctx.drawImage(video,0,0,canvas.width,canvas.height);
        try{
          const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
          // use QR lib decode if available (we used QRCode lib which doesn't provide decode)
          // fallback: ask user to switch to paste
        }catch(e){}
      }
      requestAnimationFrame(scan);
    };
    alert('Camera opened. Point to QR. (If scan is unavailable in this browser, Cancel and use paste.)');
    // NOTE: decoding QR in-browser requires a dedicated QR decoder (e.g., jsQR). To keep this file minimal we rely on manual paste fallback if decoding is not present.
    // stop stream after 30s
    setTimeout(()=>{ stream.getTracks().forEach(t=>t.stop()); alert('Camera closed. If scan did not work, use paste option.'); },30000);
  }catch(e){
    alert('Camera access denied or not available. Use paste option.');
  }
};

/* -------------------------
   Start join from code (shared helper)
   ------------------------- */
async function startJoin(code){
  // normalizes
  if(!code || code.length!==4){ alert('Room ID must be 4 digits'); return; }
  joinInput.value = code;
  await startJoinFlow(code);
}

/* wrapper to avoid naming collision with startJoin function above */
async function startJoinFlow(room){
  // reuse earlier startJoin, but we already created startJoin function above that uses startJoin variable name.
  // To avoid confusion, call startJoin(room)
  startJoin(room);
}

/* -------------------------
   UI initialization
   ------------------------- */
function refreshUIAfterProfile(){
  // hide profile edit button or show it
  editProfileBtn.style.display = 'inline-block';
  saveProfileBtn.style.display = 'none';
}
editProfileBtn.onclick = ()=>{
  saveProfileBtn.style.display = 'inline-block';
  editProfileBtn.style.display = 'none';
};

document.addEventListener('DOMContentLoaded', ()=>{
  loadProfile();
  renderEmojiSelection();
  loadRecentRooms();
});

/* duplicate functions for clarity (render emojis & recent) */
function renderEmojiSelection(){
  emojiList.innerHTML = '';
  EMOJIS.forEach(e=>{
    const btn = document.createElement('button');
    btn.className = 'emoji-btn' + (e===selectedEmoji ? ' sel' : '');
    btn.textContent = e;
    btn.onclick = ()=>{ selectedEmoji = e; document.querySelectorAll('.emoji-btn').forEach(x=>x.classList.remove('sel')); btn.classList.add('sel'); avatarEmoji.textContent = e; };
    emojiList.appendChild(btn);
  });
}

/* load recent rooms */
function loadRecentRooms(){
  recentList.innerHTML = '';
  const arr = JSON.parse(localStorage.getItem('androp_recents') || '[]');
  arr.forEach(r=>{
    const d = document.createElement('div');
    d.className = 'recent-item';
    d.innerHTML = `<div>${r}</div><div><button class="small-btn">Join</button></div>`;
    recentList.appendChild(d);
    d.querySelector('button').onclick = ()=>{ joinInput.value = r; startJoin(r); };
  });
}

/* push recent room */
function pushRecent(r){
  let arr = JSON.parse(localStorage.getItem('androp_recents') || '[]');
  arr = arr.filter(x=>x!==r);
  arr.unshift(r);
  localStorage.setItem('androp_recents', JSON.stringify(arr.slice(0,6)));
  loadRecentRooms();
}

/* helper used earlier on host start */
function pushRecentUIOnHostStart(){
  pushRecent(roomId);
  loadRecentRooms();
}

/* -------------------------
   Ensure send button toggles by DC state
   ------------------------- */
setInterval(()=>{ sendBtn.disabled = !dataChannel || dataChannel.readyState !== 'open'; },500);

/* -------------------------
   Clean unload: delete any room we created if still present
   ------------------------- */
window.addEventListener('beforeunload', async ()=>{
  if(roomId){
    try{ await removeRef(`rooms/${roomId}`); }catch(e){}
  }
});

/* -------------------------
   Small fixes: name initial save
   ------------------------- */
(function initialLoad(){
  loadProfile();
  renderEmojiSelection();
  loadRecentRooms();
})();
</script>
</body>
</html>
