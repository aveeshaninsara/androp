<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Androp</title>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f2f2f2; }
  header { padding:10px; background:#333; color:#fff; text-align:center; }
  .container { max-width:600px; margin:auto; padding:10px; }
  .section { background:#fff; padding:15px; margin:10px 0; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
  label { display:block; margin:10px 0 5px; }
  input[type=text] { width:100%; padding:8px; box-sizing:border-box; }
  select { padding:8px; width:100%; }
  button { padding:10px 15px; margin-top:10px; cursor:pointer; }
  #qr { text-align:center; margin:10px 0; }
  #fileProgress { width:100%; }
  #filesList { margin-top:10px; }
  @media(max-width:600px){ .container{padding:5px;} }
</style>
</head>
<body>

<header><h1>Androp</h1></header>
<div class="container">

  <!-- Profile Section -->
  <div class="section" id="profileSection">
    <h2>Profile</h2>
    <label>Name:</label>
    <input type="text" id="userName">
    <label>Emoji:</label>
    <select id="userEmoji"></select>
    <button id="saveProfile">Save Profile</button>
  </div>

  <!-- Connection Section -->
  <div class="section" id="connectionSection">
    <h2>Connection</h2>
    <button id="hostBtn">Host</button>
    <div id="qr"></div>
    <label>Or Join using Host ID:</label>
    <input type="text" id="joinId" placeholder="Host Peer ID">
    <button id="joinBtn">Join</button>
    <p id="status"></p>
  </div>

  <!-- File Transfer Section -->
  <div class="section" id="transferSection" style="display:none;">
    <h2>Send File</h2>
    <input type="file" id="fileInput">
    <button id="sendBtn">Send</button>
    <progress id="fileProgress" value="0" max="100"></progress>
    <div id="filesList"></div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/peerjs@1.4.7/dist/peerjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script>
  // ----------- Profile Management -----------
  const emojis = ['😀','😎','🤖','🦄','🐱','🐶','🌟','🍕','⚡','💎'];
  const emojiSelect = document.getElementById('userEmoji');
  emojis.forEach(e=>{let o=document.createElement('option'); o.value=e; o.text=e; emojiSelect.appendChild(o);});

  const userNameInput = document.getElementById('userName');
  const saveProfileBtn = document.getElementById('saveProfile');

  // Load saved profile
  if(localStorage.getItem('andropName')) userNameInput.value = localStorage.getItem('andropName');
  if(localStorage.getItem('andropEmoji')) emojiSelect.value = localStorage.getItem('andropEmoji');

  saveProfileBtn.onclick = () => {
    localStorage.setItem('andropName', userNameInput.value||`User${Math.floor(Math.random()*1000)}`);
    localStorage.setItem('andropEmoji', emojiSelect.value);
    alert('Profile saved!');
  }

  // ----------- PeerJS Setup -----------
  let peer, conn, isHost=false;

  const hostBtn = document.getElementById('hostBtn');
  const joinBtn = document.getElementById('joinBtn');
  const joinIdInput = document.getElementById('joinId');
  const qrDiv = document.getElementById('qr');
  const statusP = document.getElementById('status');
  const transferSection = document.getElementById('transferSection');
  const fileInput = document.getElementById('fileInput');
  const sendBtn = document.getElementById('sendBtn');
  const fileProgress = document.getElementById('fileProgress');
  const filesList = document.getElementById('filesList');

  // Host
  hostBtn.onclick = () => {
    isHost=true;
    peer = new Peer(undefined, {host:'peerjs.com', port:443, secure:true});
    peer.on('open', id => {
      statusP.innerText = `Your ID: ${id}`;
      QRCode.toCanvas(qrDiv, id, {width:200});
    });
    peer.on('connection', c => setupConnection(c));
  }

  // Join
  joinBtn.onclick = () => {
    const hostId = joinIdInput.value.trim();
    if(!hostId){ alert('Enter Host ID'); return; }
    peer = new Peer(undefined, {host:'peerjs.com', port:443, secure:true});
    peer.on('open', () => {
      const c = peer.connect(hostId);
      setupConnection(c);
    });
  }

  // Connection Setup
  function setupConnection(c){
    conn = c;
    statusP.innerText = 'Connected!';
    transferSection.style.display='block';
    conn.on('data', receiveData);
    conn.on('open', ()=>{ statusP.innerText = 'Connected! Ready to send files.'; });
  }

  // File Transfer
  sendBtn.onclick = () => {
    const file = fileInput.files[0];
    if(!file){ alert('Select a file'); return; }
    const chunkSize = 16*1024; // 16KB
    let offset = 0;
    fileProgress.value=0;
    function sendChunk(){
      const slice = file.slice(offset, offset+chunkSize);
      const reader = new FileReader();
      reader.onload = e => {
        conn.send(e.target.result);
        offset += chunkSize;
        fileProgress.value = Math.min(100, (offset/file.size)*100);
        if(offset < file.size) sendChunk();
      };
      reader.readAsArrayBuffer(slice);
    }
    sendChunk();
  }

  // Receiving files
  let receivedBuffers = [];
  function receiveData(data){
    receivedBuffers.push(data);
    // Simple heuristic: if last chunk smaller than 16KB, assume file finished
    if(data.byteLength < 16*1024){
      const blob = new Blob(receivedBuffers);
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `file_${Date.now()}`;
      a.innerText = 'Download received file';
      filesList.appendChild(a);
      filesList.appendChild(document.createElement('br'));
      receivedBuffers = [];
      fileProgress.value=0;
    }
  }
</script>
</body>
</html>
